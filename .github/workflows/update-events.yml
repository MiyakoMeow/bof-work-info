name: Update BMS Events

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

permissions:
  contents: write
  pull-requests: write

jobs:
  prepare-matrix:
    name: Prepare event matrix
    runs-on: ubuntu-latest
    outputs:
      keys: ${{ steps.build-matrix.outputs.keys }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build matrix keys from events.json
        id: build-matrix
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f events.json ]; then
            echo "events.json not found at repo root" >&2
            exit 1
          fi
          keys=$(jq -c '[.events[] | .key]' events.json)
          if [ -z "$keys" ] || [ "$keys" = "null" ] || [ "$keys" = "[]" ]; then
            echo "No events defined in events.json" >&2
            exit 1
          fi
          echo "keys=$keys" >> "$GITHUB_OUTPUT"

  update-event:
    name: Update ${{ matrix.event_key }}
    needs: prepare-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        event_key: ${{ fromJSON(needs.prepare-matrix.outputs.keys) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve event URL
        id: resolve
        shell: bash
        run: |
          set -euo pipefail
          # 首先尝试获取 event_id，如果不存在则尝试获取 url
          event_id=$(jq -r --arg KEY "${{ matrix.event_key }}" '.events[] | select(.key==$KEY) | .event_id' events.json)
          url=$(jq -r --arg KEY "${{ matrix.event_key }}" '.events[] | select(.key==$KEY) | .url' events.json)
          
          if [ "$event_id" != "null" ] && [ -n "$event_id" ]; then
            # 使用 event_id 构建 URL
            url="https://manbow.nothing.sh/event/event.cgi?action=URLList&end=999&event=$event_id"
            echo "Using event_id: $event_id" >&2
          elif [ "$url" != "null" ] && [ -n "$url" ]; then
            # 使用现有的 url 字段（向后兼容）
            echo "Using existing URL: $url" >&2
          else
            echo "Neither event_id nor url found for key=${{ matrix.event_key }}" >&2
            exit 1
          fi
          echo "url=$url" >> "$GITHUB_OUTPUT"

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo build
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
          workspaces: |
            . -> target

      - name: Build
        run: cargo build --release

      - name: Fetch event data
        run: |
          mkdir -p events
          echo "${{ steps.resolve.outputs.url }}" | cargo run --release -- --stdin --output "events/${{ matrix.event_key }}.toml" --log-level info

      - name: Add files to git index
        run: |
          git add events/${{ matrix.event_key }}.toml

      - name: Check for changes
        id: check-changes
        run: |
          if git diff --cached --quiet; then
            echo "No changes detected for ${{ matrix.event_key }}"
            echo "has-changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "Changes detected for ${{ matrix.event_key }}"
            echo "has-changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Pull Request
        if: steps.check-changes.outputs.has-changes == 'true'
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.AUTOMERGE_TOKEN }}
          commit-message: "chore(events): update ${{ matrix.event_key }} data"
          branch: "chore/update-${{ matrix.event_key }}"
          title: "chore(events): update ${{ matrix.event_key }} data"
          body: |
            Automated update for `${{ matrix.event_key }}`
            Source: `${{ steps.resolve.outputs.url }}`
          add-paths: |
            events/${{ matrix.event_key }}.toml
          labels: |
            automated
            event:${{ matrix.event_key }}
          delete-branch: true
          signoff: false
          committer: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          author: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>

      - name: Save PR number artifact
        if: steps.check-changes.outputs.has-changes == 'true' && steps.cpr.outputs.pull-request-number
        shell: bash
        run: |
          set -euo pipefail
          echo "${{ steps.cpr.outputs.pull-request-number }}" > pr-number.txt

      - name: Upload PR number artifact
        if: steps.check-changes.outputs.has-changes == 'true' && steps.cpr.outputs.pull-request-number
        uses: actions/upload-artifact@v4
        with:
          name: pr-number-${{ matrix.event_key }}
          path: pr-number.txt
          if-no-files-found: error

  automerge-pr:
    name: Enable auto-merge ${{ matrix.event_key }}
    needs: 
      - prepare-matrix
      - update-event
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        event_key: ${{ fromJSON(needs.prepare-matrix.outputs.keys) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check if PR artifact exists
        id: check-artifact
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            });
            
            const artifactName = `pr-number-${{ matrix.event_key }}`;
            const artifact = artifacts.data.artifacts.find(a => a.name === artifactName);
            
            if (artifact) {
              console.log(`Found artifact: ${artifactName}`);
              core.setOutput('exists', 'true');
            } else {
              console.log(`Artifact not found: ${artifactName}`);
              core.setOutput('exists', 'false');
            }

      - name: Download PR number artifact
        id: download
        if: steps.check-artifact.outputs.exists == 'true'
        uses: actions/download-artifact@v4
        with:
          name: pr-number-${{ matrix.event_key }}
          path: .
          merge-multiple: false

      - name: Read PR number
        id: read-pr
        if: steps.check-artifact.outputs.exists == 'true'
        shell: bash
        run: |
          set -euo pipefail
          if [ -f pr-number.txt ]; then
            pr=$(cat pr-number.txt | tr -d '\r\n ')
            if [ -n "$pr" ]; then
              echo "pr=$pr" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Enable auto-merge
        if: steps.read-pr.outputs.pr
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.AUTOMERGE_TOKEN }}
          pull-request-number: ${{ steps.read-pr.outputs.pr }}
          merge-method: merge
